<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Discord Bot Builder v4.3</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='4' y='4' width='56' height='56' rx='16' fill='%234f46e5' /%3E%3Ccircle cx='22' cy='26' r='6' fill='white' /%3E%3Ccircle cx='42' cy='26' r='6' fill='white' /%3E%3Cpath d='M20 42 Q32 52 44 42' stroke='white' stroke-width='4' fill='none' stroke-linecap='round' /%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly@9.0.0/python_compressed.js"></script>
    <script src="https://unpkg.com/blockly@9.0.0/msg/ja.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        #blocklyDiv {
            height: 100%;
            width: 100%;
            position: absolute;
            z-index: 10;
        }

        .blocklyToolboxDiv {
            background-color: #f8fafc;
            border-right: none;
            padding-top: 1rem;
        }
        .dark .blocklyToolboxDiv {
            background-color: #111827;
            border-right: none;
        }

        .blocklyTreeLabel {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            padding: 8px 0;
            font-size: 0.95rem;
        }
        
        .blocklyTreeRow {
            height: 44px !important;
            line-height: 44px !important;
            padding-left: 16px !important;
            border-left: 5px solid transparent;
            margin-bottom: 6px;
            transition: all 0.2s ease;
            border-radius: 0 8px 8px 0;
            margin-right: 12px;
        }
        
        .blocklyTreeRow:not(.blocklyTreeSelected):hover {
            background-color: #e2e8f0;
            border-left-color: #cbd5e1;
        }
        .blocklyTreeSelected {
            background-color: #eff6ff !important;
            border-left-color: #3b82f6 !important;
            color: #2563eb !important;
        }

        .dark .blocklyTreeLabel { color: #e5e7eb; }
        .dark .blocklyTreeRow:not(.blocklyTreeSelected):hover {
            background-color: #1f2937;
            border-left-color: #4b5563;
        }
        .dark .blocklyTreeSelected {
            background-color: #1e3a8a !important;
            border-left-color: #60a5fa !important;
            color: #93c5fd !important;
        }
        .dark .blocklyFlyoutBackground {
            fill: #1f2937;
            fill-opacity: 0.95;
        }

        #codeOutput {
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            line-height: 1.5;
        }

        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .show-modal .modal-content {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 flex flex-col h-screen overflow-hidden transition-colors duration-300">

    <header class="bg-white dark:bg-gray-800 shadow-sm px-6 py-3 flex justify-between items-center z-20 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-2 rounded-lg shadow-md">
                <i data-lucide="bot" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800 dark:text-white leading-tight">Easy Discord Bot Builder v4.3</h1>
                <p class="text-xs font-medium text-indigo-600 dark:text-indigo-400">Create by himais0giiiin!</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <span id="saveStatus" class="mr-2 text-xs font-bold text-green-600 opacity-0 transition-opacity duration-500 dark:text-green-400">ä¿å­˜ã—ã¾ã—ãŸ</span>

            <input type="file" id="importInput" accept=".xml" class="hidden">
            <button id="importBtn" class="p-2 text-gray-600 transition-colors rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­è¾¼ (XML)">
                <i data-lucide="upload" class="w-5 h-5"></i>
            </button>
            <button id="exportBtn" class="p-2 text-gray-600 transition-colors rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ (XML)">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>

            <!-- ä»¥ä¸‹ã® href="" ã®ä¸­èº«ã‚’ã€ã‚ãªãŸã®GitHub Wikiã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ -->
            <a href="https://github.com/ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå/wiki" target="_blank" rel="noopener noreferrer" class="p-2 text-gray-600 transition-colors rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 flex items-center justify-center" title="ãƒ˜ãƒ«ãƒ— / ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ">
                <i data-lucide="circle-help" class="w-5 h-5"></i>
            </a>

            <button id="themeToggle" class="p-2 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-300 text-gray-600" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
                <i data-lucide="moon" class="hidden w-5 h-5 dark:block"></i>
                <i data-lucide="sun" class="block w-5 h-5 dark:hidden"></i>
            </button>

            <button id="showCodeBtn" class="flex items-center gap-2 px-5 py-2 font-medium text-white transition-all transform rounded-lg shadow-lg bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30 hover:-translate-y-0.5">
                <i data-lucide="code" class="w-4 h-4"></i>
                <span class="hidden sm:inline">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</span>
            </button>
        </div>
    </header>

    <main class="relative w-full h-full flex-grow">
        <div id="blocklyDiv"></div>
        
        <xml id="toolbox" style="display: none">
            <category name="ã‚¤ãƒ™ãƒ³ãƒˆ" colour="#e67e22">
                <block type="on_ready"></block>
                <block type="on_message_create"></block>
                <block type="on_command_executed"></block>
                <block type="prefix_command"></block>
                <block type="get_message_content"></block>
                <block type="get_command_arg"></block>
            </category>
            
            <category name="æƒ…å ±å–å¾—" colour="#8e44ad">
                <block type="get_user_info"></block>
                <block type="get_member_detail"></block>
                <block type="member_has_role"></block>
                <block type="get_channel_info"></block>
                <block type="get_server_info"></block>
                <block type="get_current_time"></block>
            </category>

            <category name="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" colour="#3498db">
                <block type="reply_message"></block>
                <block type="defer_reply"></block>
                <block type="send_channel_message"></block>
                <block type="edit_reply"></block>
                <block type="edit_message_by_id"></block>
                <block type="delete_message"></block>
                <block type="purge_messages"></block>
                <block type="pin_message"></block>
                <block type="add_reaction"></block>
                <block type="create_thread"></block>
            </category>
            
            <category name="é«˜åº¦ãªæ“ä½œ" colour="#535c68">
                <block type="wait_for_message"></block>
                <block type="print_to_console"></block>
            </category>

            <category name="ãƒãƒ£ãƒ³ãƒãƒ«ãƒ»ãƒœã‚¤ã‚¹" colour="#00a8ff">
                <block type="join_voice_channel"></block>
                <block type="leave_voice_channel"></block>
                <block type="create_text_channel"></block>
                <block type="delete_channel"></block>
            </category>

            <category name="Botè¨­å®š" colour="#9b59b6">
                <block type="set_bot_status"></block>
                <block type="wait_seconds"></block>
            </category>

            <category name="ãƒ‡ãƒ¼ã‚¿ä¿å­˜" colour="#e67e22">
                <block type="save_to_json"></block>
                <block type="load_from_json"></block>
            </category>

            <category name="ç®¡ç†æ©Ÿèƒ½" colour="#e74c3c">
                <block type="timeout_user"></block>
                <block type="kick_user"></block>
                <block type="ban_user"></block>
                <block type="add_user_role"></block>
                <block type="remove_user_role"></block>
                <block type="create_role"></block>
                <block type="change_nickname"></block>
            </category>
            
            <category name="åŸ‹ã‚è¾¼ã¿ (Embed)" colour="#2ecc71">
                <block type="create_embed"></block>
                <block type="set_embed_property"></block>
                <block type="add_embed_field"></block>
            </category>

            <sep></sep>
            
            <category name="å¤‰æ•°" colour="#a55b6a" custom="VARIABLE"></category>

            <category name="ãƒ‡ãƒ¼ã‚¿æ§‹é€  (ãƒªã‚¹ãƒˆ)" colour="#a55b80">
                <block type="lists_create_with"></block>
                <block type="lists_length"></block>
                <block type="lists_getIndex"></block>
                <block type="lists_setIndex"></block>
                <block type="lists_append_to"></block>
                <block type="random_choice"></block>
            </category>
            
            <category name="é–¢æ•° (ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³)" colour="#7b5ba5" custom="PROCEDURE"></category>

            <sep></sep>

            <category name="æ¡ä»¶åˆ†å²ãƒ»æ¯”è¼ƒ" colour="#f1c40f">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_boolean"></block>
            </category>

            <category name="ç¹°ã‚Šè¿”ã—" colour="#5b67a5">
                <block type="controls_repeat_ext"></block>
                <block type="controls_whileUntil"></block>
            </category>

            <category name="ç®—è¡“ãƒ»ä¹±æ•°" colour="#5b80a5">
                <block type="math_number"></block>
                <block type="math_arithmetic"></block>
                <block type="math_single"></block>
                <block type="math_round"></block>
                <block type="random_integer"></block>
            </category>

            <category name="æ–‡å­—åˆ—æ“ä½œ" colour="#5ba58c">
                <block type="text"></block>
                <block type="text_join"></block>
                <block type="text_length"></block>
                <block type="text_replace"></block>
                <block type="text_charAt"></block>
                <block type="text_print"></block>
            </category>
        </xml>
    </main>

    <div id="codeModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 backdrop-blur-sm bg-gray-900/50">
        <div class="flex flex-col w-full max-w-4xl max-h-[90vh] overflow-hidden rounded-xl shadow-2xl bg-white dark:bg-gray-800 modal-content border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between p-5 border-b bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 rounded bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300">
                        <i data-lucide="file-code" class="w-5 h-5"></i>
                    </div>
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white">Botã‚³ãƒ¼ãƒ‰ (Python)</h2>
                </div>
                <button id="closeModalBtn" class="p-1 transition-colors rounded text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:hover:text-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="flex-grow p-6 overflow-y-auto bg-white dark:bg-gray-900">
                <div class="mb-6 space-y-3 p-4 rounded-lg border bg-indigo-50 dark:bg-indigo-900/30 border-indigo-100 dark:border-indigo-800">
                    <h3 class="flex items-center gap-2 font-bold text-indigo-800 dark:text-indigo-300">
                        <i data-lucide="info" class="w-4 h-4"></i> å®Ÿè¡Œæ–¹æ³•
                    </h3>
                    <ol class="space-y-1 text-sm list-decimal list-inside text-indigo-700 dark:text-indigo-300">
                        <li>ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ <code class="px-1 py-0.5 rounded border dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">bot.py</code> ã¨ã„ã†åå‰ã§ä¿å­˜ã—ã¾ã™ã€‚</li>
                        <li>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ <code class="px-1 py-0.5 rounded border select-all dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">pip install discord.py</code> ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</li>
                        <li>ãƒœã‚¤ã‚¹æ©Ÿèƒ½ã‚’ä½¿ã†å ´åˆ: <code class="px-1 py-0.5 rounded border select-all dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">pip install "discord.py[voice]"</code></li>
                        <li><code class="px-1 py-0.5 rounded border select-all dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">python bot.py</code> ã‚’å®Ÿè¡Œã—ã¦Botã‚’èµ·å‹•ã—ã¾ã™ã€‚</li>
                    </ol>
                </div>

                <div class="relative group">
                    <div class="absolute top-3 right-3 z-10 opacity-0 transition-opacity group-hover:opacity-100">
                        <button id="copyCodeBtn" class="flex items-center gap-1 px-3 py-1.5 text-xs text-white rounded shadow-lg bg-indigo-600 hover:bg-indigo-700 border border-indigo-500">
                            <i data-lucide="copy" class="w-3 h-3"></i> ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    <pre id="codeOutput" class="p-4 text-sm rounded-lg shadow-inner tab-4 bg-[#1e1e1e] text-[#d4d4d4] border border-gray-700"></pre>
                </div>
            </div>
            
            <div class="flex items-center justify-center gap-1 p-3 text-xs text-center text-gray-500 border-t bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700">
                <i data-lucide="shield-check" class="w-3 h-3"></i> Tokenã¯Discord Developer Portalã‹ã‚‰å–å¾—ã—ã€ä»–äººã«ã¯æ•™ãˆãªã„ã§ãã ã•ã„ã€‚
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let workspace;
        const STORAGE_KEY = 'discord_bot_builder_workspace_public';

        const setupBlocklyEnvironment = () => {
            const modernLightTheme = Blockly.Theme.defineTheme('modernLight', {
                'base': Blockly.Themes.Classic,
                'componentStyles': {
                    'workspaceBackgroundColour': '#f3f4f6',
                    'toolboxBackgroundColour': '#f8fafc',
                    'toolboxForegroundColour': '#334155',
                    'flyoutBackgroundColour': '#ffffff',
                    'flyoutForegroundColour': '#334155',
                    'flyoutOpacity': 1,
                    'scrollbarColour': '#cbd5e1',
                    'insertionMarkerColour': '#fff',
                    'insertionMarkerOpacity': 0.3,
                }
            });

            const modernDarkTheme = Blockly.Theme.defineTheme('modernDark', {
                'base': Blockly.Themes.Classic,
                'componentStyles': {
                    'workspaceBackgroundColour': '#111827',
                    'toolboxBackgroundColour': '#1f2937',
                    'toolboxForegroundColour': '#e2e8f0',
                    'flyoutBackgroundColour': '#1f2937',
                    'flyoutForegroundColour': '#e2e8f0',
                    'flyoutOpacity': 1,
                    'scrollbarColour': '#4b5563',
                    'insertionMarkerColour': '#fff',
                    'insertionMarkerOpacity': 0.3,
                },
                'blockStyles': {
                    'hat_blocks': {'colourPrimary': '#a55b80'}
                }
            });

            Blockly.Python.INDENT = '    ';
            
            Blockly.Blocks['on_ready'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ BotãŒèµ·å‹•ã—ãŸã¨ã");
                    this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                    this.setColour(30);
                    this.setTooltip("Botã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã€æº–å‚™ãŒã§ããŸæ™‚ã«1å›ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['on_message_create'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ã");
                    this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                    this.setColour(30);
                    this.setTooltip("èª°ã‹ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚");
                }
            };
            
            Blockly.Blocks['get_message_content'] = {
                init: function() {
                    this.appendDummyInput().appendField("å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹");
                    this.setOutput(true, "String");
                    this.setColour(30);
                    this.setTooltip("å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ã‚’å–å¾—ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['on_command_executed'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("âš¡ ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ /")
                        .appendField(new Blockly.FieldTextInput("hello"), "COMMAND_NAME")
                        .appendField("ã‚’ä½¿ã‚ã‚ŒãŸã¨ã");
                    this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                    this.setColour(230);
                    this.setTooltip("æŒ‡å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹: /helloï¼‰ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®å‹•ä½œã‚’ä½œã‚Šã¾ã™ã€‚");
                }
            };
            
            Blockly.Blocks['prefix_command'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸ—£ï¸ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰")
                        .appendField(new Blockly.FieldTextInput("!ping"), "COMMAND_NAME")
                        .appendField("ã‚’å®Ÿè¡Œã—ãŸã¨ã");
                    this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                    this.setColour(230);
                    this.setTooltip("æŒ‡å®šã—ãŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹: !pingï¼‰ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®å‹•ä½œã‚’ä½œã‚Šã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['get_command_arg'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ã‚³ãƒãƒ³ãƒ‰å¼•æ•°")
                        .appendField(new Blockly.FieldTextInput("name"), "ARG_NAME")
                        .appendField("ã®å€¤");
                    this.setOutput(true, ["String", "Number"]);
                    this.setColour(230);
                    this.setTooltip("ã‚³ãƒãƒ³ãƒ‰ã¨ä¸€ç·’ã«é€ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆå¼•æ•°ï¼‰ã‚’å–å¾—ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['get_user_info'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸ‘¤ å®Ÿè¡Œè€…ã®")
                        .appendField(new Blockly.FieldDropdown([
                            ["ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", "id"],
                            ["åå‰ (ãƒ¦ãƒ¼ã‚¶ãƒ¼å)", "name"],
                            ["è¡¨ç¤ºå (ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ )", "display_name"],
                            ["ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ (<@ID>)", "mention"]
                        ]), "TYPE");
                    this.setOutput(true, "String");
                    this.setColour(260);
                }
            };

            Blockly.Blocks['get_member_detail'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸ‘¤ å®Ÿè¡Œè€…ã®è©³ç´°:")
                        .appendField(new Blockly.FieldDropdown([
                            ["ã‚¢ãƒã‚¿ãƒ¼URL", "avatar.url"],
                            ["ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ—¥", "created_at"],
                            ["ã‚µãƒ¼ãƒãƒ¼å‚åŠ æ—¥", "joined_at"],
                            ["ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "status"],
                        ]), "TYPE");
                    this.setOutput(true, "String");
                    this.setColour(260);
                }
            };

            Blockly.Blocks['get_channel_info'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸ“º ç¾åœ¨ã®")
                        .appendField(new Blockly.FieldDropdown([
                            ["ãƒãƒ£ãƒ³ãƒãƒ«ID", "id"],
                            ["ãƒãƒ£ãƒ³ãƒãƒ«å", "name"],
                            ["ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ (<#ID>)", "mention"]
                        ]), "TYPE");
                    this.setOutput(true, "String");
                    this.setColour(260);
                }
            };

            Blockly.Blocks['get_server_info'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸŒ ã‚µãƒ¼ãƒãƒ¼ã®")
                        .appendField(new Blockly.FieldDropdown([
                            ["ã‚µãƒ¼ãƒãƒ¼ID", "id"],
                            ["ã‚µãƒ¼ãƒãƒ¼å", "name"],
                            ["ãƒ¡ãƒ³ãƒãƒ¼æ•°", "member_count"]
                        ]), "TYPE");
                    this.setOutput(true, ["String", "Number"]);
                    this.setColour(260);
                }
            };

            Blockly.Blocks['member_has_role'] = {
                init: function() {
                    this.appendValueInput("USER").setCheck("String").appendField("â“ ãƒ¦ãƒ¼ã‚¶ãƒ¼");
                    this.appendValueInput("ROLE_ID").setCheck("String").appendField("ãŒãƒ­ãƒ¼ãƒ«(ID)");
                    this.appendDummyInput().appendField("ã‚’æŒã£ã¦ã„ã‚‹");
                    this.setOutput(true, "Boolean");
                    this.setColour(260);
                    this.setTooltip("æŒ‡å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç‰¹å®šã®ãƒ­ãƒ¼ãƒ«IDã‚’æŒã£ã¦ã„ã‚‹ã‹åˆ¤å®šã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['get_current_time'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ•’ ç¾åœ¨æ™‚åˆ» (æ–‡å­—åˆ—)");
                    this.setOutput(true, "String");
                    this.setColour(260);
                }
            };

            Blockly.Blocks['reply_message'] = {
                init: function() {
                    this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("â†©ï¸ è¿”ä¿¡ã™ã‚‹");
                    this.appendDummyInput()
                        .appendField("è‡ªåˆ†ã ã‘ã«è¡¨ç¤º")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "EPHEMERAL");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };

            Blockly.Blocks['defer_reply'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("â³ å¿œç­”ã‚’ä¿ç•™ã™ã‚‹ (è€ƒãˆä¸­...)")
                        .appendField("è‡ªåˆ†ã ã‘")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "EPHEMERAL");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’é˜²ãã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['edit_reply'] = {
                init: function() {
                    this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("âœï¸ è¿”ä¿¡ã‚’ç·¨é›†ã™ã‚‹");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };

            Blockly.Blocks['edit_message_by_id'] = {
                init: function() {
                    this.appendValueInput("CHANNEL_ID").setCheck("String").appendField("âœï¸ ç·¨é›†: ãƒãƒ£ãƒ³ãƒãƒ«ID");
                    this.appendValueInput("MESSAGE_ID").setCheck("String").appendField("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID");
                    this.appendValueInput("CONTENT").setCheck("String").appendField("æ–°ã—ã„å†…å®¹");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };

            Blockly.Blocks['send_channel_message'] = {
                init: function() {
                    this.appendValueInput("CHANNEL_ID").setCheck("String").appendField("#ï¸âƒ£ ãƒãƒ£ãƒ³ãƒãƒ«ID");
                    this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("ã«é€ä¿¡");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };

            Blockly.Blocks['delete_message'] = {
                init: function() { 
                    this.appendDummyInput().appendField("ğŸ—‘ï¸ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };
            
            Blockly.Blocks['purge_messages'] = {
                init: function() {
                    this.appendValueInput("LIMIT").setCheck("Number").appendField("ğŸ—‘ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ‹¬å‰Šé™¤ï¼ˆ");
                    this.appendDummyInput().appendField("ä»¶ï¼‰");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };

            Blockly.Blocks['pin_message'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ“Œ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ”ãƒ³ç•™ã‚");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };
            
            Blockly.Blocks['add_reaction'] = {
                init: function() {
                    this.appendValueInput("EMOJI").setCheck("String").appendField("ğŸ‘ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };
            
            Blockly.Blocks['create_thread'] = {
                init: function() {
                    this.appendValueInput("NAME").setCheck("String").appendField("ğŸ§µ ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆï¼ˆåå‰");
                    this.appendDummyInput().appendField("ï¼‰");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };

            Blockly.Blocks['wait_for_message'] = {
                init: function() {
                    this.appendValueInput("TIMEOUT").setCheck("Number").appendField("â³ è¿”ä¿¡ã‚’å¾…ã¤ (æœ€å¤§");
                    this.appendDummyInput().appendField("ç§’)");
                    this.setOutput(true, "String");
                    this.setColour(290);
                    this.setTooltip("åŒã˜ãƒãƒ£ãƒ³ãƒãƒ«ã§å®Ÿè¡Œè€…ã‹ã‚‰ã®æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã¡ã€ãã®å†…å®¹ã‚’è¿”ã—ã¾ã™ã€‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ç©ºæ–‡å­—ã«ãªã‚Šã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['print_to_console'] = {
                init: function() {
                    this.appendValueInput("TEXT").setCheck(null).appendField("ğŸ–¨ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160); 
                    this.setTooltip("Botã®ãƒ­ã‚°ç”»é¢ã«æ–‡å­—ã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ã€‚");
                }
            };

            Blockly.Blocks['join_voice_channel'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ”Š å®Ÿè¡Œè€…ã®ãƒœã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ ");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(340);
                    this.setTooltip("ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚‹ãƒœã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒãƒ«ã«Botã‚’å‚åŠ ã•ã›ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['leave_voice_channel'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ”‡ ãƒœã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰åˆ‡æ–­");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(340);
                }
            };

            Blockly.Blocks['create_text_channel'] = {
                init: function() {
                    this.appendValueInput("NAME").setCheck("String").appendField("ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(340);
                }
            };

            Blockly.Blocks['delete_channel'] = {
                init: function() {
                    this.appendValueInput("CHANNEL_ID").setCheck("String").appendField("ğŸ—‘ï¸ ãƒãƒ£ãƒ³ãƒãƒ«å‰Šé™¤ (ID");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(340);
                }
            };

            Blockly.Blocks['set_bot_status'] = {
                init: function() {
                    this.appendValueInput("STATUS").setCheck("String").appendField("ğŸ® ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’");
                    this.appendDummyInput()
                        .appendField(new Blockly.FieldDropdown([
                            ["ãƒ—ãƒ¬ã‚¤ä¸­", "playing"],
                            ["è¦–è´ä¸­", "watching"],
                            ["å†ç”Ÿä¸­", "listening"],
                        ]), "TYPE")
                        .appendField("ã«ã™ã‚‹");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(260);
                }
            };

            Blockly.Blocks['wait_seconds'] = {
                init: function() {
                    this.appendValueInput("SECONDS").setCheck("Number").appendField("â³");
                    this.appendDummyInput().appendField("ç§’å¾…ã¤");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(260);
                }
            };

            // --- JSON Data Blocks ---
            Blockly.Blocks['save_to_json'] = {
                init: function() {
                    this.appendValueInput("KEY").setCheck("String").appendField("ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ ã‚­ãƒ¼:");
                    this.appendValueInput("VALUE").setCheck(null).appendField("å€¤:");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(30);
                    this.setTooltip("æŒ‡å®šã—ãŸã‚­ãƒ¼ã¨å€¤ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['load_from_json'] = {
                init: function() {
                    this.appendValueInput("KEY").setCheck("String").appendField("ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ ã‚­ãƒ¼:");
                    this.setInputsInline(true);
                    this.setOutput(true, null);
                    this.setColour(30);
                    this.setTooltip("ä¿å­˜ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æŒ‡å®šã—ãŸã‚­ãƒ¼ã®å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['create_embed'] = {
                init: function() {
                    this.appendDummyInput().appendField("âœ¨ æ–°ã—ã„åŸ‹ã‚è¾¼ã¿(Embed)ä½œæˆ");
                    this.appendStatementInput("PROPERTIES").setCheck(null);
                    this.setOutput(true, "Embed");
                    this.setColour(100);
                }
            };

            Blockly.Blocks['set_embed_property'] = {
                init: function() {
                    this.appendValueInput("VALUE").setCheck("String")
                        .appendField("è¨­å®šï¼š")
                        .appendField(new Blockly.FieldDropdown([
                            ["ã‚¿ã‚¤ãƒˆãƒ«", "title"],
                            ["èª¬æ˜æ–‡", "description"],
                            ["è‰² (0xHex)", "color"],
                            ["ç”»åƒURL", "image"],
                        ]), "PROPERTY");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(100);
                }
            };

            Blockly.Blocks['add_embed_field'] = {
                init: function() {
                    this.appendValueInput("NAME").setCheck("String").appendField("é …ç›®å");
                    this.appendValueInput("VALUE").setCheck("String").appendField("å†…å®¹");
                    this.appendDummyInput().appendField("æ¨ªä¸¦ã³").appendField(new Blockly.FieldCheckbox("TRUE"), "INLINE");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(100);
                }
            };

            Blockly.Blocks['kick_user'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ‘¢ Kickã™ã‚‹ (ID");
                    this.appendValueInput("REASON").setCheck("String").appendField("ç†ç”±");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };

            Blockly.Blocks['ban_user'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸš« BANã™ã‚‹ (ID");
                    this.appendValueInput("REASON").setCheck("String").appendField("ç†ç”±");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };

            Blockly.Blocks['timeout_user'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ”‡ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (ID");
                    this.appendValueInput("MINUTES").setCheck("Number").appendField("åˆ†");
                    this.appendDummyInput().appendField("é–“)");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };

            Blockly.Blocks['add_user_role'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("â• ãƒ­ãƒ¼ãƒ«ä»˜ä¸ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ID");
                    this.appendValueInput("ROLE_ID").setCheck("String").appendField("ãƒ­ãƒ¼ãƒ«ID");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };
            
            Blockly.Blocks['remove_user_role'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("â– ãƒ­ãƒ¼ãƒ«å‰¥å¥ª (ãƒ¦ãƒ¼ã‚¶ãƒ¼ID");
                    this.appendValueInput("ROLE_ID").setCheck("String").appendField("ãƒ­ãƒ¼ãƒ«ID");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };

            Blockly.Blocks['create_role'] = {
                init: function() {
                    this.appendValueInput("NAME").setCheck("String").appendField("ğŸ”° æ–°è¦ãƒ­ãƒ¼ãƒ«ä½œæˆ (åå‰");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };
            
            Blockly.Blocks['change_nickname'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ·ï¸ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´ (ID");
                    this.appendValueInput("NAME").setCheck("String").appendField("æ–°ã—ã„åå‰");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };

            Blockly.Blocks['lists_append_to'] = {
                init: function() {
                    this.appendValueInput('LIST').setCheck('Array').appendField('ãƒªã‚¹ãƒˆ');
                    this.appendValueInput('ITEM').setCheck(null).appendField('ã«é …ç›®');
                    this.appendDummyInput().appendField('ã‚’è¿½åŠ ');
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                }
            };
            
            Blockly.Blocks['random_choice'] = {
                init: function() {
                    this.appendValueInput("LIST").setCheck("Array").appendField("ğŸ² ãƒªã‚¹ãƒˆ");
                    this.appendDummyInput().appendField("ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶");
                    this.setOutput(true, null);
                    this.setColour(230);
                }
            };

            Blockly.Blocks['random_integer'] = {
                init: function() {
                    this.appendValueInput("FROM")
                        .setCheck("Number")
                        .appendField("ğŸ² ä¹±æ•° (æœ€å°");
                    this.appendValueInput("TO")
                        .setCheck("Number")
                        .appendField("ã€œ æœ€å¤§");
                    this.appendDummyInput()
                        .appendField(")");
                    this.setInputsInline(true);
                    this.setOutput(true, "Number");
                    this.setColour(230);
                }
            };

            Blockly.Blocks['text_replace'] = {
                init: function() {
                    this.appendValueInput("TEXT").setCheck("String").appendField("ãƒ†ã‚­ã‚¹ãƒˆ");
                    this.appendValueInput("FROM").setCheck("String").appendField("ã®ä¸­ã®");
                    this.appendValueInput("TO").setCheck("String").appendField("ã‚’");
                    this.appendDummyInput().appendField("ã«ç½®æ›ã™ã‚‹");
                    this.setInputsInline(true);
                    this.setOutput(true, "String");
                    this.setColour(160);
                }
            };
                
            const getBranchCode = (block, name) => {
                let code = Blockly.Python.statementToCode(block, name);
                if (!code || code.trim() === '') {
                    return Blockly.Python.INDENT + 'pass\n';
                }
                return code;
            };

            Blockly.Python['on_ready'] = function(block) {
                const branch = getBranchCode(block, 'DO');
                return `
@bot.event
async def on_ready():
    print(f'Logged in as {bot.user}')
    try:
        synced = await bot.tree.sync()
        print(f"Synced {len(synced)} command(s)")
    except Exception as e:
        print(e)
${branch.trimEnd()}
`;
            };

            Blockly.Python['on_message_create'] = function(block) {
                const branch = getBranchCode(block, 'DO');
                return `
@bot.event
async def on_message(message):
    if message.author == bot.user:
        return
    ctx = message
    user = message.author
${branch.trimEnd()}
    await bot.process_commands(message)
`;
            };

            Blockly.Python['get_message_content'] = function(block) {
                return ['(ctx.content if "ctx" in locals() and hasattr(ctx, "content") else "")', Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['on_command_executed'] = function(block) {
                const commandName = block.getFieldValue('COMMAND_NAME').toLowerCase();
                const branch = getBranchCode(block, 'DO');
                return `
@bot.tree.command(name="${commandName}", description="${commandName} command")
async def ${commandName}_cmd(interaction: discord.Interaction):
    ctx = interaction
    user = interaction.user
${branch.trimEnd()}
`;
            };
            
            Blockly.Python['prefix_command'] = function(block) {
                const commandName = block.getFieldValue('COMMAND_NAME').replace(/^[!~#&?]/, '');
                const branch = getBranchCode(block, 'DO');
                return `
@bot.command(name='${commandName}')
async def ${commandName}_cmd(ctx):
    user = ctx.author
${branch.trimEnd()}
`;
            };

            Blockly.Python['get_command_arg'] = function(block) {
                const argName = block.getFieldValue('ARG_NAME');
                return [`# Argument '${argName}' needed`, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['get_user_info'] = function(block) {
                const type = block.getFieldValue('TYPE');
                let code = `user.${type}`;
                if (type === 'name') code = 'user.name';
                if (type === 'display_name') code = 'user.display_name';
                return [`(${code} if "user" in locals() else "Unknown")`, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['get_member_detail'] = function(block) {
                const type = block.getFieldValue('TYPE');
                let code = `user.${type}`;
                if (type === 'avatar.url') code = 'str(user.avatar.url) if user.avatar else ""';
                if (type === 'created_at') code = 'str(user.created_at.strftime("%Y-%m-%d %H:%M"))';
                if (type === 'joined_at') code = 'str(user.joined_at.strftime("%Y-%m-%d %H:%M")) if hasattr(user, "joined_at") else ""';
                if (type === 'status') code = 'str(user.status) if hasattr(user, "status") else "unknown"';
                return [`(${code} if "user" in locals() else "Unknown")`, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['get_channel_info'] = function(block) {
                const type = block.getFieldValue('TYPE');
                let code = `ctx.channel.${type}`;
                return [`(${code} if "ctx" in locals() and hasattr(ctx, "channel") else "Unknown")`, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['get_server_info'] = function(block) {
                const type = block.getFieldValue('TYPE');
                let code = `ctx.guild.${type}`;
                return [`(${code} if "ctx" in locals() and ctx.guild else "Unknown")`, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['member_has_role'] = function(block) {
                const userCode = Blockly.Python.valueToCode(block, 'USER', Blockly.Python.ORDER_NONE) || '0';
                const roleId = Blockly.Python.valueToCode(block, 'ROLE_ID', Blockly.Python.ORDER_NONE) || '0';
                const code = `(discord.utils.get(ctx.guild.get_member(int(${userCode})).roles, id=int(${roleId})) is not None if "ctx" in locals() and ctx.guild and str(${userCode}).isdigit() and str(${roleId}).isdigit() else False)`;
                return [code, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['get_current_time'] = function(block) {
                return [`datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')`, Blockly.Python.ORDER_ATOMIC];
            };
            
            Blockly.Python['reply_message'] = function(block) {
                const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
                const ephemeral = block.getFieldValue('EPHEMERAL') === 'TRUE' ? 'True' : 'False';
                let contentCode = msg.startsWith('discord.Embed') ? `embed=${msg}` : `content=${msg}`;
                
                return `
if 'ctx' in locals():
    if isinstance(ctx, discord.Interaction):
        if ctx.response.is_done():
            await ctx.followup.send(${contentCode}, ephemeral=${ephemeral})
        else:
            await ctx.response.send_message(${contentCode}, ephemeral=${ephemeral})
    elif isinstance(ctx, commands.Context):
        await ctx.send(${contentCode})
    elif isinstance(ctx, discord.Message):
        await ctx.reply(${contentCode})
`;
            };

            Blockly.Python['defer_reply'] = function(block) {
                const ephemeral = block.getFieldValue('EPHEMERAL') === 'TRUE' ? 'True' : 'False';
                return `
if 'ctx' in locals():
    if isinstance(ctx, discord.Interaction):
        await ctx.response.defer(ephemeral=${ephemeral})
    elif isinstance(ctx, commands.Context):
        async with ctx.typing(): pass
`;
            };

            Blockly.Python['edit_reply'] = function(block) {
                const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
                let contentCode = msg.startsWith('discord.Embed') ? `embed=${msg}` : `content=${msg}`;
                return `
if 'ctx' in locals() and isinstance(ctx, discord.Interaction):
    await ctx.edit_original_response(${contentCode})
`;
            };

            Blockly.Python['edit_message_by_id'] = function(block) {
                const channelId = Blockly.Python.valueToCode(block, 'CHANNEL_ID', Blockly.Python.ORDER_NONE) || '0';
                const messageId = Blockly.Python.valueToCode(block, 'MESSAGE_ID', Blockly.Python.ORDER_NONE) || '0';
                const content = Blockly.Python.valueToCode(block, 'CONTENT', Blockly.Python.ORDER_NONE) || '""';
                return `
try:
    _ch = bot.get_channel(int(${channelId}))
    if _ch:
        _msg = await _ch.fetch_message(int(${messageId}))
        if _msg: await _msg.edit(content=${content})
except Exception as e:
    print(f"Edit Error: {e}")
`;
            };

            Blockly.Python['send_channel_message'] = function(block) {
                const channelId = Blockly.Python.valueToCode(block, 'CHANNEL_ID', Blockly.Python.ORDER_NONE) || '0';
                const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
                const contentArg = msg.startsWith('discord.Embed') ? `embed=${msg}` : `content=${msg}`;
                return `
_ch_id = int(${channelId}) if str(${channelId}).isdigit() else 0
_channel = bot.get_channel(_ch_id)
if _channel:
    await _channel.send(${contentArg})
`;
            };

            Blockly.Python['delete_message'] = function(block) {
                return `
if 'ctx' in locals():
    if isinstance(ctx, discord.Message):
        await ctx.delete()
    elif isinstance(ctx, commands.Context):
        await ctx.message.delete()
`;
            };
            
            Blockly.Python['purge_messages'] = function(block) {
                const limit = Blockly.Python.valueToCode(block, 'LIMIT', Blockly.Python.ORDER_NONE) || '5';
                return `
if 'ctx' in locals() and hasattr(ctx, 'channel') and hasattr(ctx.channel, 'purge'):
    await ctx.channel.purge(limit=int(${limit}))
`;
            };

            Blockly.Python['pin_message'] = function(block) {
                return `
if 'ctx' in locals():
    if isinstance(ctx, discord.Message):
        await ctx.pin()
    elif isinstance(ctx, commands.Context):
        await ctx.message.pin()
`;
            };
            
            Blockly.Python['add_reaction'] = function(block) {
                const emoji = Blockly.Python.valueToCode(block, 'EMOJI', Blockly.Python.ORDER_NONE) || '"ğŸ‘"';
                return `
try:
    if 'ctx' in locals():
        if isinstance(ctx, discord.Message): 
            await ctx.add_reaction(${emoji})
        elif isinstance(ctx, commands.Context): 
            await ctx.message.add_reaction(${emoji})
except Exception:
    pass
`;
            };
            
            Blockly.Python['create_thread'] = function(block) {
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"New Thread"';
                return `
try:
    if 'ctx' in locals():
        if isinstance(ctx, discord.Message): 
            await ctx.create_thread(name=${name})
        elif isinstance(ctx, commands.Context): 
            await ctx.message.create_thread(name=${name})
except Exception:
    pass
`;
            };

            Blockly.Python['wait_for_message'] = function(block) {
                const timeout = Blockly.Python.valueToCode(block, 'TIMEOUT', Blockly.Python.ORDER_NONE) || '30';
                const code = `
(await bot.wait_for('message', check=lambda m: m.channel == ctx.channel and m.author == user, timeout=${timeout})).content
`.trim();
                return [code, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['print_to_console'] = function(block) {
                const text = Blockly.Python.valueToCode(block, 'TEXT', Blockly.Python.ORDER_NONE) || '""';
                return `print(${text})\n`;
            };

            Blockly.Python['join_voice_channel'] = function(block) {
                return `
if 'user' in locals() and user.voice:
    await user.voice.channel.connect()
`;
            };

            Blockly.Python['leave_voice_channel'] = function(block) {
                return `
if 'ctx' in locals() and ctx.guild.voice_client:
    await ctx.guild.voice_client.disconnect()
`;
            };

            Blockly.Python['create_text_channel'] = function(block) {
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"new-channel"';
                return `
if 'ctx' in locals() and ctx.guild:
    await ctx.guild.create_text_channel(name=${name})
`;
            };

            Blockly.Python['delete_channel'] = function(block) {
                const channelId = Blockly.Python.valueToCode(block, 'CHANNEL_ID', Blockly.Python.ORDER_NONE) || '0';
                return `
_ch = bot.get_channel(int(${channelId}))
if _ch:
    await _ch.delete()
`;
            };

            Blockly.Python['set_bot_status'] = function(block) {
                const status = Blockly.Python.valueToCode(block, 'STATUS', Blockly.Python.ORDER_NONE) || '"Bot"';
                const type = block.getFieldValue('TYPE');
                let activityCode = `discord.Game(name=${status})`;
                if (type === 'watching') activityCode = `discord.Activity(type=discord.ActivityType.watching, name=${status})`;
                if (type === 'listening') activityCode = `discord.Activity(type=discord.ActivityType.listening, name=${status})`;
                return `await bot.change_presence(activity=${activityCode})\n`;
            };

            Blockly.Python['wait_seconds'] = function(block) {
                const sec = Blockly.Python.valueToCode(block, 'SECONDS', Blockly.Python.ORDER_NONE) || '1';
                return `await asyncio.sleep(${sec})\n`;
            };

            // --- JSON Data Generators ---
            Blockly.Python['save_to_json'] = function(block) {
                const key = Blockly.Python.valueToCode(block, 'KEY', Blockly.Python.ORDER_NONE) || '"key"';
                const value = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || 'None';
                return `_save_data(${key}, ${value})\n`;
            };

            Blockly.Python['load_from_json'] = function(block) {
                const key = Blockly.Python.valueToCode(block, 'KEY', Blockly.Python.ORDER_NONE) || '"key"';
                return [`_get_data(${key})`, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['create_embed'] = function(block) {
                const embedVarName = Blockly.Python.variableDB_.getDistinctName('embed', Blockly.Names.VARIABLE_NAME);
                let code = `
${embedVarName} = discord.Embed(title="No Title", description="...", color=0x3498DB)
`.trim() + '\n';
                const propertiesCode = Blockly.Python.statementToCode(block, 'PROPERTIES');
                const lines = propertiesCode.split('\n');
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    if (line.includes('# EMBED_VAR_PLACEHOLDER')) {
                        code += line.replace(/# EMBED_VAR_PLACEHOLDER/g, embedVarName) + '\n';
                    } else if (line.trim().startsWith('embed.')) {
                        code += line.replace(/embed\./g, `${embedVarName}.`) + '\n';
                    }
                }
                return [`${embedVarName}`, Blockly.Python.ORDER_ATOMIC];
            };
            
            Blockly.Python['set_embed_property'] = function(block) {
                const property = block.getFieldValue('PROPERTY');
                const value = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || '""';
                if (property === 'color') return `embed.color = ${value}\n`;
                if (property === 'image') return `embed.set_image(url=${value})\n`;
                if (property === 'title') return `embed.title = ${value}\n`;
                if (property === 'description') return `embed.description = ${value}\n`;
                return '';
            };
            
            Blockly.Python['add_embed_field'] = function(block) {
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"Name"';
                const value = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || '"Value"';
                const inline = block.getFieldValue('INLINE') === 'TRUE' ? 'True' : 'False';
                return `# EMBED_VAR_PLACEHOLDER.add_field(name=${name}, value=${value}, inline=${inline})\n`;
            };

            Blockly.Python['kick_user'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE) || '0';
                const reason = Blockly.Python.valueToCode(block, 'REASON', Blockly.Python.ORDER_NONE) || 'None';
                return `
if 'ctx' in locals() and ctx.guild:
    _m = ctx.guild.get_member(int(${user}))
    if _m: await _m.kick(reason=${reason})
`;
            };
            
            Blockly.Python['ban_user'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE) || '0';
                const reason = Blockly.Python.valueToCode(block, 'REASON', Blockly.Python.ORDER_NONE) || 'None';
                return `
if 'ctx' in locals() and ctx.guild:
    _m = ctx.guild.get_member(int(${user}))
    if _m: await _m.ban(reason=${reason})
`;
            };
            
            Blockly.Python['timeout_user'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE) || '0';
                const mins = Blockly.Python.valueToCode(block, 'MINUTES', Blockly.Python.ORDER_NONE) || '5';
                return `
if 'ctx' in locals() and ctx.guild:
    _m = ctx.guild.get_member(int(${user}))
    if _m:
        await _m.timeout(datetime.timedelta(minutes=int(${mins})))
`;
            };

            Blockly.Python['add_user_role'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE) || '0';
                const role = Blockly.Python.valueToCode(block, 'ROLE_ID', Blockly.Python.ORDER_NONE) || '0';
                return `
if 'ctx' in locals() and ctx.guild:
    _m = ctx.guild.get_member(int(${user}))
    _r = ctx.guild.get_role(int(${role}))
    if _m and _r: await _m.add_roles(_r)
`;
            };

            Blockly.Python['remove_user_role'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE) || '0';
                const role = Blockly.Python.valueToCode(block, 'ROLE_ID', Blockly.Python.ORDER_NONE) || '0';
                return `
if 'ctx' in locals() and ctx.guild:
    _m = ctx.guild.get_member(int(${user}))
    _r = ctx.guild.get_role(int(${role}))
    if _m and _r: await _m.remove_roles(_r)
`;
            };

            Blockly.Python['create_role'] = function(block) {
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"New Role"';
                return `
if 'ctx' in locals() and ctx.guild:
    await ctx.guild.create_role(name=${name})
`;
            };
            
            Blockly.Python['change_nickname'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE) || '0';
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"New Nick"';
                return `
if 'ctx' in locals() and ctx.guild:
    _m = ctx.guild.get_member(int(${user}))
    if _m: await _m.edit(nick=${name})
`;
            };

            Blockly.Python['procedures_defnoreturn'] = Blockly.Python['procedures_defreturn'] = function(block) {
                const funcName = Blockly.Python.variableDB_.getName(block.getFieldValue('NAME'), Blockly.Names.PROCEDURE_NAME);
                const branch = getBranchCode(block, 'STACK');
                
                let args = [];
                for (let i = 0; i < block.arguments_.length; i++) {
                    args.push(Blockly.Python.variableDB_.getName(block.arguments_[i], Blockly.Names.VARIABLE_NAME));
                }
                const argsString = args.join(', ');

                let returnValue = Blockly.Python.valueToCode(block, 'RETURN', Blockly.Python.ORDER_NONE) || '';
                let returnCode = '';
                if (block.type === 'procedures_defreturn' && returnValue) {
                    returnCode = `${Blockly.Python.INDENT}return ${returnValue}\n`;
                }

                return `
async def ${funcName}(${argsString}):
${branch.trimEnd()}
${returnCode.trimEnd()}
`;
            };

            Blockly.Python['procedures_callnoreturn'] = function(block) {
                const funcName = Blockly.Python.variableDB_.getName(block.getFieldValue('NAME'), Blockly.Names.PROCEDURE_NAME);
                const args = [];
                for (let i = 0; i < block.arguments_.length; i++) {
                    args.push(Blockly.Python.valueToCode(block, 'ARG' + i, Blockly.Python.ORDER_NONE) || 'None');
                }
                return `await ${funcName}(${args.join(', ')})\n`;
            };

            Blockly.Python['procedures_callreturn'] = function(block) {
                const funcName = Blockly.Python.variableDB_.getName(block.getFieldValue('NAME'), Blockly.Names.PROCEDURE_NAME);
                const args = [];
                for (let i = 0; i < block.arguments_.length; i++) {
                    args.push(Blockly.Python.valueToCode(block, 'ARG' + i, Blockly.Python.ORDER_NONE) || 'None');
                }
                return [`await ${funcName}(${args.join(', ')})`, Blockly.Python.ORDER_FUNCTION_CALL];
            };

            Blockly.Python['lists_create_with'] = function(block) {
                const elements = [];
                for (let i = 0; i < block.itemCount_; i++) {
                    elements.push(Blockly.Python.valueToCode(block, 'ADD' + i, Blockly.Python.ORDER_NONE) || 'None');
                }
                return ['[' + elements.join(', ') + ']', Blockly.Python.ORDER_ATOMIC];
            };
            
            Blockly.Python['lists_length'] = function(block) {
                const list = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || '[]';
                return [`len(${list})`, Blockly.Python.ORDER_FUNCTION_CALL];
            };
            
            Blockly.Python['lists_append_to'] = function(block) {
                const list = Blockly.Python.valueToCode(block, 'LIST', Blockly.Python.ORDER_MEMBER) || '[]';
                const item = Blockly.Python.valueToCode(block, 'ITEM', Blockly.Python.ORDER_NONE) || 'None';
                return `${list}.append(${item})\n`;
            };
            
            Blockly.Python['random_choice'] = function(block) {
                const list = Blockly.Python.valueToCode(block, 'LIST', Blockly.Python.ORDER_NONE) || '[]';
                return [`random.choice(${list})`, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['lists_getIndex'] = function(block) {
                const mode = block.getFieldValue('MODE') || 'GET';
                const where = block.getFieldValue('WHERE') || 'FROM_START';
                const list = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_MEMBER) || '[]';
                
                let code, at;

                if (where === 'FROM_START') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_ADDITIVE) || '1';
                    at = Blockly.isNumber(at) ? parseInt(at, 10) - 1 : `(int(${at}) - 1)`;
                    if (mode === 'GET') code = `${list}[${at}]`;
                    else if (mode === 'GET_REMOVE') code = `${list}.pop(${at})`;
                    else if (mode === 'REMOVE') code = `del ${list}[${at}]\n`;
                } else if (where === 'FROM_END') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_UNARY_SIGN) || '1';
                    at = Blockly.isNumber(at) ? -parseInt(at, 10) : `-int(${at})`;
                    if (mode === 'GET') code = `${list}[${at}]`;
                    else if (mode === 'GET_REMOVE') code = `${list}.pop(${at})`;
                    else if (mode === 'REMOVE') code = `del ${list}[${at}]\n`;
                } else if (where === 'FIRST') {
                    if (mode === 'GET') code = `${list}[0]`;
                    else if (mode === 'GET_REMOVE') code = `${list}.pop(0)`;
                    else if (mode === 'REMOVE') code = `del ${list}[0]\n`;
                } else if (where === 'LAST') {
                    if (mode === 'GET') code = `${list}[-1]`;
                    else if (mode === 'GET_REMOVE') code = `${list}.pop()`;
                    else if (mode === 'REMOVE') code = `del ${list}[-1]\n`;
                } else {
                     return Blockly.Python.lists_getIndex(block);
                }
                if (mode === 'REMOVE') return code;
                return [code, Blockly.Python.ORDER_MEMBER];
            };

            Blockly.Python['lists_setIndex'] = function(block) {
                const mode = block.getFieldValue('MODE') || 'SET';
                const where = block.getFieldValue('WHERE') || 'FROM_START';
                const list = Blockly.Python.valueToCode(block, 'LIST', Blockly.Python.ORDER_MEMBER) || '[]';
                const value = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || 'None';
                
                let code, at;
                if (where === 'FROM_START') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_ADDITIVE) || '1';
                    at = Blockly.isNumber(at) ? parseInt(at, 10) - 1 : `(int(${at}) - 1)`;
                    if (mode === 'SET') code = `${list}[${at}] = ${value}\n`;
                    else if (mode === 'INSERT') code = `${list}.insert(${at}, ${value})\n`;
                } else if (where === 'FIRST') {
                    if (mode === 'SET') code = `${list}[0] = ${value}\n`;
                    else if (mode === 'INSERT') code = `${list}.insert(0, ${value})\n`;
                } else if (where === 'LAST') {
                    if (mode === 'SET') code = `${list}[-1] = ${value}\n`;
                    else if (mode === 'INSERT') code = `${list}.append(${value})\n`; 
                } else if (where === 'FROM_END') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_UNARY_SIGN) || '1';
                    if (mode === 'SET') {
                        const setAt = Blockly.isNumber(at) ? -parseInt(at, 10) : `-int(${at})`;
                        code = `${list}[${setAt}] = ${value}\n`;
                    } else if (mode === 'INSERT') {
                        const insertAt = Blockly.isNumber(at) ? `len(${list}) - ${parseInt(at, 10)}` : `len(${list}) - int(${at})`;
                        code = `${list}.insert(${insertAt}, ${value})\n`;
                    }
                } else {
                    return Blockly.Python.lists_setIndex(block);
                }
                return code;
            };
            
            Blockly.Python['random_integer'] = function(block) {
                const from = Blockly.Python.valueToCode(block, 'FROM', Blockly.Python.ORDER_NONE) || '0';
                const to = Blockly.Python.valueToCode(block, 'TO', Blockly.Python.ORDER_NONE) || '100';
                return [`random.randint(int(${from}), int(${to}))`, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['text_replace'] = function(block) {
                const text = Blockly.Python.valueToCode(block, 'TEXT', Blockly.Python.ORDER_MEMBER) || "''";
                const from = Blockly.Python.valueToCode(block, 'FROM', Blockly.Python.ORDER_NONE) || "''";
                const to = Blockly.Python.valueToCode(block, 'TO', Blockly.Python.ORDER_NONE) || "''";
                return [`str(${text}).replace(str(${from}), str(${to}))`, Blockly.Python.ORDER_MEMBER];
            };

            Blockly.Python['text_charAt'] = function(block) {
                const where = block.getFieldValue('WHERE') || 'FROM_START';
                const text = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_MEMBER) || "''";
                let code, at;

                if (where === 'FROM_START') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_ADDITIVE) || '1';
                    at = Blockly.isNumber(at) ? parseInt(at, 10) - 1 : `(int(${at}) - 1)`;
                    code = `${text}[${at}]`;
                } else if (where === 'FIRST') {
                    code = `${text}[0]`;
                } else if (where === 'LAST') {
                    code = `${text}[-1]`;
                } else if (where === 'FROM_END') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_UNARY_SIGN) || '1';
                    at = Blockly.isNumber(at) ? -parseInt(at, 10) : `-int(${at})`;
                    code = `${text}[${at}]`;
                } else {
                    code = `${text}[0]`;
                }
                return [code, Blockly.Python.ORDER_MEMBER];
            };
            
            Blockly.Python['controls_if'] = function(block) {
                let code = '';
                let condition = Blockly.Python.valueToCode(block, 'IF0', Blockly.Python.ORDER_NONE) || 'False';
                let branchCode = getBranchCode(block, 'DO0');
                code += `if ${condition}:\n${branchCode}`;

                for (let i = 1; i <= block.elseifCount_; i++) {
                    condition = Blockly.Python.valueToCode(block, 'IF' + i, Blockly.Python.ORDER_NONE) || 'False';
                    branchCode = getBranchCode(block, 'DO' + i);
                    code += `elif ${condition}:\n${branchCode}`;
                }
                
                if (block.elseCount_) {
                    branchCode = getBranchCode(block, 'ELSE');
                    code += `else:\n${branchCode}`;
                }
                return code;
            };

            return { modernLightTheme, modernDarkTheme };
        };
        
        const html = document.documentElement;

        const toggleTheme = (modernLightTheme, modernDarkTheme) => {
            const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.classList.remove(currentTheme);
            html.classList.add(newTheme);
            localStorage.setItem('theme', newTheme);
            if (workspace) {
                workspace.setTheme(newTheme === 'dark' ? modernDarkTheme : modernLightTheme);
            }
        };

        const generatePythonCode = () => {
            if (!workspace) return '';
            let rawCode = Blockly.Python.workspaceToCode(workspace);
            
            const rootIndent = Blockly.Python.INDENT;
            let cleanedCode = rawCode.split('\n')
                .map(line => line.startsWith(rootIndent) ? line.substring(rootIndent.length) : line)
                .join('\n').trim();

            const boilerplate = `
# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import discord
from discord import app_commands
from discord.ext import commands
import random
import asyncio
import datetime
import math
import json
import os

intents = discord.Intents.default()
intents.message_content = True 
intents.members = True 

# Botã®ä½œæˆ
bot = commands.Bot(command_prefix='!', intents=intents)

# --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
DATA_FILE = "bot_data.json"

def _load_all_data():
    if not os.path.exists(DATA_FILE):
        return {}
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except:
        return {}

def _save_data(key, value):
    data = _load_all_data()
    data[str(key)] = value
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def _get_data(key):
    data = _load_all_data()
    return data.get(str(key))
# ------------------------------

# --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ ---
${cleanedCode}
# --------------------------

bot.run('TOKEN') # å®Ÿè¡Œæ™‚ã¯ã“ã“ã«Tokenã‚’å…¥ã‚Œã¦ãã ã•ã„
`;
            return boilerplate.trim();
        };

        const initializeApp = () => {
            const { modernLightTheme, modernDarkTheme } = setupBlocklyEnvironment();

            const blocklyDiv = document.getElementById('blocklyDiv');
            const toolbox = document.getElementById('toolbox');
            const themeToggle = document.getElementById('themeToggle');
            const showCodeBtn = document.getElementById('showCodeBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const copyCodeBtn = document.getElementById('copyCodeBtn');
            const codeModal = document.getElementById('codeModal');
            const codeOutput = document.getElementById('codeOutput');
            const importBtn = document.getElementById('importBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importInput = document.getElementById('importInput');
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') html.classList.add('dark');
            const initialTheme = savedTheme === 'dark' ? modernDarkTheme : modernLightTheme;

            workspace = Blockly.inject(blocklyDiv, {
                toolbox: toolbox,
                horizontalLayout: false,
                trashcan: true,
                zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
                renderer: 'zelos',
                theme: initialTheme
            });

            const pinBtn = document.createElement('button');
            pinBtn.id = 'toolboxPinBtn';
            pinBtn.className = 'absolute z-50 p-1.5 rounded-lg text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 dark:text-gray-400 dark:hover:text-indigo-400 dark:hover:bg-gray-700 transition-all duration-200 shadow-sm border border-transparent hover:border-indigo-100 dark:hover:border-gray-600';
            pinBtn.style.top = '8px';
            
            const updatePinState = () => {
                if (!workspace) return;
                const toolbox = workspace.getToolbox();
                if (!toolbox) return;
                
                let isVisible = true;
                if (typeof toolbox.isVisible === 'function') {
                    isVisible = toolbox.isVisible();
                } else if (typeof toolbox.getWidth === 'function') {
                    isVisible = toolbox.getWidth() > 0;
                }
                
                const width = (typeof toolbox.getWidth === 'function') ? toolbox.getWidth() : 0;
                
                if (isVisible) {
                    pinBtn.style.left = `${width - 34}px`;
                    pinBtn.innerHTML = '<i data-lucide="pin" class="w-4 h-4 fill-indigo-500 text-indigo-600"></i>';
                    pinBtn.classList.add('bg-white', 'dark:bg-gray-800');
                } else {
                    pinBtn.style.left = '8px';
                    pinBtn.innerHTML = '<i data-lucide="pin-off" class="w-4 h-4"></i>';
                    pinBtn.classList.remove('bg-white', 'dark:bg-gray-800');
                    pinBtn.classList.add('bg-white/80', 'dark:bg-gray-800/80', 'backdrop-blur');
                }
                lucide.createIcons();
            };

            pinBtn.onclick = () => {
                const toolbox = workspace.getToolbox();
                if (!toolbox) return;

                let isVisible = true;
                if (typeof toolbox.isVisible === 'function') {
                    isVisible = toolbox.isVisible();
                } else if (typeof toolbox.getWidth === 'function') {
                    isVisible = toolbox.getWidth() > 0;
                }

                if (typeof toolbox.setVisible === 'function') {
                    toolbox.setVisible(!isVisible);
                }
                
                Blockly.svgResize(workspace);
                setTimeout(updatePinState, 50); 
            };

            document.getElementById('blocklyDiv').appendChild(pinBtn);
            
            setTimeout(updatePinState, 100);
            window.addEventListener('resize', () => {
                Blockly.svgResize(workspace);
                updatePinState();
            });
            
            workspace.addChangeListener((e) => {
                if (e.type === Blockly.Events.TOOLBOX_ITEM_SELECT) {
                    setTimeout(updatePinState, 50);
                }
            });

            const xmlText = localStorage.getItem(STORAGE_KEY);
            if (xmlText) {
                try {
                    Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(xmlText), workspace);
                } catch (e) { console.error(e); }
            }

            workspace.addChangeListener((e) => {
                if (e.isUiEvent || e.type === Blockly.Events.FINISHED_LOADING) return;
                const xml = Blockly.Xml.workspaceToDom(workspace);
                localStorage.setItem(STORAGE_KEY, Blockly.Xml.domToText(xml));
                const saveStatus = document.getElementById('saveStatus');
                saveStatus.style.opacity = '1';
                setTimeout(() => saveStatus.style.opacity = '0', 2000);
            });

            themeToggle.addEventListener('click', () => toggleTheme(modernLightTheme, modernDarkTheme));
            
            importBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(e.target.result), workspace);
                    } catch (err) { console.error(err); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            exportBtn.addEventListener('click', () => {
                const xml = Blockly.Xml.workspaceToDom(workspace);
                const blob = new Blob([Blockly.Xml.domToText(xml)], {type: 'text/xml'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bot-project.xml`;
                a.click();
                URL.revokeObjectURL(url);
            });

            showCodeBtn.addEventListener('click', () => {
                codeOutput.textContent = generatePythonCode();
                codeModal.classList.remove('hidden');
                codeModal.classList.add('flex');
                setTimeout(() => codeModal.classList.add('show-modal'), 10);
            });

            closeModalBtn.addEventListener('click', () => {
                codeModal.classList.remove('show-modal');
                setTimeout(() => {
                    codeModal.classList.remove('flex');
                    codeModal.classList.add('hidden');
                }, 200);
            });
            
            copyCodeBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(codeOutput.textContent);
                copyCodeBtn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> ã‚³ãƒ”ãƒ¼å®Œäº†';
                lucide.createIcons();
                setTimeout(() => {
                    copyCodeBtn.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i> ã‚³ãƒ”ãƒ¼';
                    lucide.createIcons();
                }, 2000);
            });
        };

        window.onload = initializeApp;
    </script>
</body>
</html>