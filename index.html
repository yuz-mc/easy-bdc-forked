<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot Builder (Public Edition)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Blockly Library -->
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly@9.0.0/python_compressed.js"></script> <!-- Python Generator -->
    <script src="https://unpkg.com/blockly@9.0.0/msg/ja.js"></script> <!-- æ—¥æœ¬èªåŒ–ãƒ‘ãƒƒã‚¯ -->
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Blocklyã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        #blocklyDiv {
            height: 100%;
            width: 100%;
            position: absolute;
            z-index: 10;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .blocklyToolboxDiv {
            background-color: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding-top: 1rem;
        }
        .dark .blocklyToolboxDiv {
            background-color: #111827;
            border-right: 1px solid #374151;
        }

        .blocklyTreeLabel {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            padding: 8px 0;
            font-size: 0.95rem;
        }
        
        .blocklyTreeRow {
            height: 44px !important;
            line-height: 44px !important;
            padding-left: 16px !important;
            border-left: 5px solid transparent;
            margin-bottom: 6px;
            transition: all 0.2s ease;
            border-radius: 0 8px 8px 0;
            margin-right: 12px;
        }
        
        /* Light Mode */
        .blocklyTreeRow:not(.blocklyTreeSelected):hover {
            background-color: #e2e8f0;
            border-left-color: #cbd5e1;
        }
        .blocklyTreeSelected {
            background-color: #eff6ff !important;
            border-left-color: #3b82f6 !important;
            color: #2563eb !important;
        }

        /* Dark Mode */
        .dark .blocklyTreeLabel { color: #e5e7eb; }
        .dark .blocklyTreeRow:not(.blocklyTreeSelected):hover {
            background-color: #1f2937;
            border-left-color: #4b5563;
        }
        .dark .blocklyTreeSelected {
            background-color: #1e3a8a !important;
            border-left-color: #60a5fa !important;
            color: #93c5fd !important;
        }
        .dark .blocklyFlyoutBackground {
            fill: #1f2937;
            fill-opacity: 0.95;
        }

        /* ã‚³ãƒ¼ãƒ‰å‡ºåŠ›ã‚¨ãƒªã‚¢ */
        #codeOutput {
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            line-height: 1.5;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .show-modal .modal-content {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 flex flex-col h-screen overflow-hidden transition-colors duration-300">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white dark:bg-gray-800 shadow-sm px-6 py-3 flex justify-between items-center z-20 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-2 rounded-lg shadow-md">
                <i data-lucide="bot" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800 dark:text-white leading-tight">Discord Bot Builder</h1>
                <p class="text-xs font-medium text-indigo-600 dark:text-indigo-400">Public Edition (Python)</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <span id="saveStatus" class="mr-2 text-xs font-bold text-green-600 opacity-0 transition-opacity duration-500 dark:text-green-400">ä¿å­˜ã—ã¾ã—ãŸ</span>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒœã‚¿ãƒ³ -->
            <input type="file" id="importInput" accept=".xml" class="hidden">
            <button id="importBtn" class="p-2 text-gray-600 transition-colors rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­è¾¼ (XML)">
                <i data-lucide="upload" class="w-5 h-5"></i>
            </button>
            <button id="exportBtn" class="p-2 text-gray-600 transition-colors rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ (XML)">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>

            <div class="w-px h-6 mx-1 bg-gray-300 dark:bg-gray-600"></div>

            <button id="themeToggle" class="p-2 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-300 text-gray-600" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
                <i data-lucide="moon" class="hidden w-5 h-5 dark:block"></i>
                <i data-lucide="sun" class="block w-5 h-5 dark:hidden"></i>
            </button>

            <button id="showCodeBtn" class="flex items-center gap-2 px-5 py-2 font-medium text-white transition-all transform rounded-lg shadow-lg bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30 hover:-translate-y-0.5">
                <i data-lucide="code" class="w-4 h-4"></i>
                <span class="hidden sm:inline">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</span>
            </button>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <main class="relative w-full h-full flex-grow">
        <div id="blocklyDiv"></div>
        
        <!-- ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹å®šç¾© (å¤šæ©Ÿèƒ½åŒ– & ã‚ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èª) -->
        <xml id="toolbox" style="display: none">
            <category name="ã‚¤ãƒ™ãƒ³ãƒˆ" colour="#e67e22">
                <block type="on_ready"></block>
                <block type="on_message_create"></block>
                <block type="on_command_executed"></block>
                <block type="prefix_command"></block> <!-- è¿½åŠ  -->
                <block type="get_message_content"></block>
                <block type="get_command_arg"></block>
            </category>
            
            <category name="æƒ…å ±å–å¾—" colour="#8e44ad">
                <block type="get_user_info"></block>
                <block type="get_channel_info"></block>
                <block type="get_server_info"></block>
            </category>

            <category name="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" colour="#3498db">
                <block type="reply_message"></block>
                <block type="send_channel_message"></block>
                <block type="edit_reply"></block>
                <block type="delete_message"></block>
                <block type="purge_messages"></block>
                <block type="pin_message"></block>
                <block type="add_reaction"></block>
                <block type="create_thread"></block>
            </category>
            
            <category name="ãƒãƒ£ãƒ³ãƒãƒ«æ“ä½œ" colour="#3498db">
                <block type="create_text_channel"></block>
                <block type="delete_channel"></block>
            </category>

            <category name="Botè¨­å®š" colour="#9b59b6">
                <block type="set_bot_status"></block>
                <block type="wait_seconds"></block>
            </category>

            <category name="ç®¡ç†æ©Ÿèƒ½" colour="#e74c3c">
                <block type="timeout_user"></block>
                <block type="kick_user"></block>
                <block type="ban_user"></block>
                <block type="add_user_role"></block>
                <block type="remove_user_role"></block>
                <block type="create_role"></block>
                <block type="change_nickname"></block>
            </category>
            
            <category name="åŸ‹ã‚è¾¼ã¿ (Embed)" colour="#2ecc71">
                <block type="create_embed"></block>
                <block type="set_embed_property"></block>
                <block type="add_embed_field"></block>
            </category>

            <sep></sep>

            <category name="ãƒ­ã‚¸ãƒƒã‚¯" colour="#f1c40f">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_boolean"></block>
            </category>

            <category name="ãƒ«ãƒ¼ãƒ—" colour="#5b67a5">
                <block type="controls_repeat_ext"></block>
                <block type="controls_whileUntil"></block>
            </category>

            <category name="æ•°å€¤ãƒ»è¨ˆç®—" colour="#5b80a5">
                <block type="math_number"></block>
                <block type="math_arithmetic"></block>
                <block type="random_integer"></block>
            </category>

            <category name="ãƒ†ã‚­ã‚¹ãƒˆ" colour="#5ba58c">
                <block type="text"></block>
                <block type="text_join"></block>
                <block type="text_length"></block>
                <block type="text_print"></block>
            </category>
        </xml>
    </main>

    <!-- ã‚³ãƒ¼ãƒ‰å‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="codeModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 backdrop-blur-sm bg-gray-900/50">
        <div class="flex flex-col w-full max-w-4xl max-h-[90vh] overflow-hidden rounded-xl shadow-2xl bg-white dark:bg-gray-800 modal-content border border-gray-200 dark:border-gray-700">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="flex items-center justify-between p-5 border-b bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 rounded bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300">
                        <i data-lucide="file-code" class="w-5 h-5"></i>
                    </div>
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white">Botã‚³ãƒ¼ãƒ‰ (Python)</h2>
                </div>
                <button id="closeModalBtn" class="p-1 transition-colors rounded text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:hover:text-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœãƒ‡ã‚£ -->
            <div class="flex-grow p-6 overflow-y-auto bg-white dark:bg-gray-900">
                <div class="mb-6 space-y-3 p-4 rounded-lg border bg-indigo-50 dark:bg-indigo-900/30 border-indigo-100 dark:border-indigo-800">
                    <h3 class="flex items-center gap-2 font-bold text-indigo-800 dark:text-indigo-300">
                        <i data-lucide="info" class="w-4 h-4"></i> å®Ÿè¡Œæ–¹æ³•
                    </h3>
                    <ol class="space-y-1 text-sm list-decimal list-inside text-indigo-700 dark:text-indigo-300">
                        <li>ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ <code class="px-1 py-0.5 rounded border dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">bot.py</code> ã¨ã„ã†åå‰ã§ä¿å­˜ã—ã¾ã™ã€‚</li>
                        <li>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ <code class="px-1 py-0.5 rounded border select-all dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">pip install discord.py</code> ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</li>
                        <li><code class="px-1 py-0.5 rounded border select-all dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">python bot.py</code> ã‚’å®Ÿè¡Œã—ã¦Botã‚’èµ·å‹•ã—ã¾ã™ã€‚</li>
                    </ol>
                </div>

                <div class="relative group">
                    <div class="absolute top-3 right-3 z-10 opacity-0 transition-opacity group-hover:opacity-100">
                        <button id="copyCodeBtn" class="flex items-center gap-1 px-3 py-1.5 text-xs text-white rounded shadow-lg bg-indigo-600 hover:bg-indigo-700 border border-indigo-500">
                            <i data-lucide="copy" class="w-3 h-3"></i> ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    <pre id="codeOutput" class="p-4 text-sm rounded-lg shadow-inner tab-4 bg-[#1e1e1e] text-[#d4d4d4] border border-gray-700"></pre>
                </div>
            </div>
            
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div class="flex items-center justify-center gap-1 p-3 text-xs text-center text-gray-500 border-t bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700">
                <i data-lucide="shield-check" class="w-3 h-3"></i> Tokenã¯Discord Developer Portalã‹ã‚‰å–å¾—ã—ã€ä»–äººã«ã¯æ•™ãˆãªã„ã§ãã ã•ã„ã€‚
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let workspace;
        const STORAGE_KEY = 'discord_bot_builder_workspace_public';

        // ===========================================
        // 0. ãƒ†ãƒ¼ãƒè¨­å®š & æ—¥æœ¬èªåŒ–è¨­å®š
        // ===========================================
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        
        // Blocklyãƒ†ãƒ¼ãƒè¨­å®š
        const modernLightTheme = Blockly.Theme.defineTheme('modernLight', {
            'base': Blockly.Themes.Classic,
            'componentStyles': {
                'workspaceBackgroundColour': '#f3f4f6',
                'toolboxBackgroundColour': '#f8fafc',
                'toolboxForegroundColour': '#334155',
                'flyoutBackgroundColour': '#ffffff',
                'flyoutForegroundColour': '#334155',
                'flyoutOpacity': 1,
                'scrollbarColour': '#cbd5e1',
                'insertionMarkerColour': '#fff',
                'insertionMarkerOpacity': 0.3,
            }
        });

        const modernDarkTheme = Blockly.Theme.defineTheme('modernDark', {
            'base': Blockly.Themes.Classic,
            'componentStyles': {
                'workspaceBackgroundColour': '#111827',
                'toolboxBackgroundColour': '#1f2937',
                'toolboxForegroundColour': '#e2e8f0',
                'flyoutBackgroundColour': '#1f2937',
                'flyoutForegroundColour': '#e2e8f0',
                'flyoutOpacity': 1,
                'scrollbarColour': '#4b5563',
                'insertionMarkerColour': '#fff',
                'insertionMarkerOpacity': 0.3,
            },
            'blockStyles': {
                'hat_blocks': {'colourPrimary': '#a55b80'}
            }
        });

        function toggleTheme() {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
                if (workspace) workspace.setTheme(modernLightTheme);
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                if (workspace) workspace.setTheme(modernDarkTheme);
                localStorage.setItem('theme', 'dark');
            }
        }

        // åˆæœŸãƒ†ãƒ¼ãƒèª­ã¿è¾¼ã¿
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            html.classList.add('dark');
            html.classList.remove('light');
        }

        themeToggle.addEventListener('click', toggleTheme);

        // ===========================================
        // 1. Blockly ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯å®šç¾© (å®Œå…¨æ—¥æœ¬èª)
        // ===========================================

        // --- ã‚¤ãƒ™ãƒ³ãƒˆ ---
        Blockly.Blocks['on_ready'] = {
            init: function() {
                this.appendDummyInput().appendField("ğŸ BotãŒèµ·å‹•ã—ãŸã¨ã");
                this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                this.setColour(30);
                this.setTooltip("Botã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã€æº–å‚™ãŒã§ããŸæ™‚ã«1å›ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['on_message_create'] = {
            init: function() {
                this.appendDummyInput().appendField("ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ã");
                this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                this.setColour(30);
                this.setTooltip("èª°ã‹ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚");
            }
        };
        
        Blockly.Blocks['get_message_content'] = {
            init: function() {
                this.appendDummyInput().appendField("å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹");
                this.setOutput(true, "String");
                this.setColour(30);
                this.setTooltip("å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ã‚’å–å¾—ã—ã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['on_command_executed'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("âš¡ ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ /")
                    .appendField(new Blockly.FieldTextInput("hello"), "COMMAND_NAME")
                    .appendField("ã‚’ä½¿ã‚ã‚ŒãŸã¨ã");
                this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                this.setColour(230);
                this.setTooltip("æŒ‡å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹: /helloï¼‰ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®å‹•ä½œã‚’ä½œã‚Šã¾ã™ã€‚");
            }
        };
        
        // --- ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ (è¿½åŠ ) ---
        Blockly.Blocks['prefix_command'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("ğŸ—£ï¸ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰")
                    .appendField(new Blockly.FieldTextInput("!ping"), "COMMAND_NAME")
                    .appendField("ã‚’å®Ÿè¡Œã—ãŸã¨ã");
                this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                this.setColour(230); // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã¨åŒã˜è‰²
                this.setTooltip("æŒ‡å®šã—ãŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹: !pingï¼‰ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®å‹•ä½œã‚’ä½œã‚Šã¾ã™ã€‚");
            }
        };
        // ------------------------------------

        Blockly.Blocks['get_command_arg'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("ã‚³ãƒãƒ³ãƒ‰å¼•æ•°")
                    .appendField(new Blockly.FieldTextInput("name"), "ARG_NAME")
                    .appendField("ã®å€¤");
                this.setOutput(true, ["String", "Number"]);
                this.setColour(230);
                this.setTooltip("ã‚³ãƒãƒ³ãƒ‰ã¨ä¸€ç·’ã«é€ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆå¼•æ•°ï¼‰ã‚’å–å¾—ã—ã¾ã™ã€‚");
            }
        };

        // --- æƒ…å ±å–å¾— (New) ---
        Blockly.Blocks['get_user_info'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("ğŸ‘¤ å®Ÿè¡Œè€…ã®")
                    .appendField(new Blockly.FieldDropdown([
                        ["ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", "id"],
                        ["åå‰ (ãƒ¦ãƒ¼ã‚¶ãƒ¼å)", "name"],
                        ["è¡¨ç¤ºå (ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ )", "display_name"],
                        ["ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ (<@ID>)", "mention"]
                    ]), "TYPE");
                this.setOutput(true, "String");
                this.setColour(260); // Purple
                this.setTooltip("ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸäººã€ã¾ãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸäººã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['get_channel_info'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("ğŸ“º ç¾åœ¨ã®")
                    .appendField(new Blockly.FieldDropdown([
                        ["ãƒãƒ£ãƒ³ãƒãƒ«ID", "id"],
                        ["ãƒãƒ£ãƒ³ãƒãƒ«å", "name"],
                        ["ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ (<#ID>)", "mention"]
                    ]), "TYPE");
                this.setOutput(true, "String");
                this.setColour(260);
                this.setTooltip("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['get_server_info'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("ğŸŒ ã‚µãƒ¼ãƒãƒ¼ã®")
                    .appendField(new Blockly.FieldDropdown([
                        ["ã‚µãƒ¼ãƒãƒ¼ID", "id"],
                        ["ã‚µãƒ¼ãƒãƒ¼å", "name"],
                        ["ãƒ¡ãƒ³ãƒãƒ¼æ•°", "member_count"]
                    ]), "TYPE");
                this.setOutput(true, ["String", "Number"]);
                this.setColour(260);
                this.setTooltip("ç¾åœ¨ã®ã‚µãƒ¼ãƒãƒ¼ï¼ˆã‚®ãƒ«ãƒ‰ï¼‰ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚");
            }
        };

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        Blockly.Blocks['reply_message'] = {
            init: function() {
                this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("â†©ï¸ è¿”ä¿¡ã™ã‚‹");
                this.appendDummyInput()
                    .appendField("è‡ªåˆ†ã ã‘ã«è¡¨ç¤º")
                    .appendField(new Blockly.FieldCheckbox("FALSE"), "EPHEMERAL");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("ã‚³ãƒãƒ³ãƒ‰ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã—ã¦è¿”ä¿¡ã‚’ã—ã¾ã™ã€‚ã€Œè‡ªåˆ†ã ã‘ã«è¡¨ç¤ºã€ã¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã§ã®ã¿æœ‰åŠ¹ã§ã™ã€‚");
            }
        };

        Blockly.Blocks['edit_reply'] = {
            init: function() {
                this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("âœï¸ è¿”ä¿¡ã‚’ç·¨é›†ã™ã‚‹");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("æ—¢ã«é€ä¿¡ã—ãŸè¿”ä¿¡ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['send_channel_message'] = {
            init: function() {
                this.appendValueInput("CHANNEL_ID").setCheck("String").appendField("#ï¸âƒ£ ãƒãƒ£ãƒ³ãƒãƒ«ID");
                this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("ã«é€ä¿¡");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("æŒ‡å®šã—ãŸIDã®ãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['delete_message'] = {
            init: function() {
                this.appendDummyInput().appendField("ğŸ—‘ï¸ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆBotã«æ¨©é™ãŒå¿…è¦ã§ã™ï¼‰ã€‚");
            }
        };
        
        Blockly.Blocks['purge_messages'] = {
            init: function() {
                this.appendValueInput("LIMIT").setCheck("Number").appendField("ğŸ—‘ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ‹¬å‰Šé™¤ï¼ˆ");
                this.appendDummyInput().appendField("ä»¶ï¼‰");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("ç¾åœ¨ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æœ€æ–°ã‹ã‚‰æŒ‡å®šã—ãŸä»¶æ•°ã ã‘å‰Šé™¤ã—ã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['pin_message'] = {
            init: function() {
                this.appendDummyInput().appendField("ğŸ“Œ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ”ãƒ³ç•™ã‚");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
            }
        };
        
        Blockly.Blocks['add_reaction'] = {
            init: function() {
                this.appendValueInput("EMOJI").setCheck("String").appendField("ğŸ‘ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã¾ã™ã€‚çµµæ–‡å­—ã¯ãã®ã¾ã¾å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ğŸ‘ï¼‰ã€‚");
            }
        };
        
        Blockly.Blocks['create_thread'] = {
            init: function() {
                this.appendValueInput("NAME").setCheck("String").appendField("ğŸ§µ ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆï¼ˆåå‰");
                this.appendDummyInput().appendField("ï¼‰");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("ç¾åœ¨ã®ãƒãƒ£ãƒ³ãƒãƒ«ã«æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚");
            }
        };

        // --- ãƒãƒ£ãƒ³ãƒãƒ«æ“ä½œ ---
        Blockly.Blocks['create_text_channel'] = {
            init: function() {
                this.appendValueInput("NAME").setCheck("String").appendField("ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(340);
            }
        };

        Blockly.Blocks['delete_channel'] = {
            init: function() {
                this.appendValueInput("CHANNEL_ID").setCheck("String").appendField("ğŸ—‘ï¸ ãƒãƒ£ãƒ³ãƒãƒ«å‰Šé™¤ (ID");
                this.appendDummyInput().appendField(")");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(340);
            }
        };

        // --- Botè¨­å®š & ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        Blockly.Blocks['set_bot_status'] = {
            init: function() {
                this.appendValueInput("STATUS").setCheck("String").appendField("ğŸ® ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’");
                this.appendDummyInput()
                    .appendField(new Blockly.FieldDropdown([
                        ["ãƒ—ãƒ¬ã‚¤ä¸­", "playing"],
                        ["è¦–è´ä¸­", "watching"],
                        ["å†ç”Ÿä¸­", "listening"],
                    ]), "TYPE")
                    .appendField("ã«ã™ã‚‹");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(260);
                this.setTooltip("Botã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨­å®šã—ã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['wait_seconds'] = {
            init: function() {
                this.appendValueInput("SECONDS").setCheck("Number").appendField("â³");
                this.appendDummyInput().appendField("ç§’å¾…ã¤");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(260);
                this.setTooltip("æŒ‡å®šã—ãŸç§’æ•°ã ã‘å‡¦ç†ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã™ã€‚");
            }
        };

        // --- Embed ---
        Blockly.Blocks['create_embed'] = {
            init: function() {
                this.appendDummyInput().appendField("âœ¨ æ–°ã—ã„åŸ‹ã‚è¾¼ã¿(Embed)ä½œæˆ");
                this.appendStatementInput("PROPERTIES").setCheck(null);
                this.setOutput(true, "Embed");
                this.setColour(100);
            }
        };

        Blockly.Blocks['set_embed_property'] = {
            init: function() {
                this.appendValueInput("VALUE").setCheck("String")
                    .appendField("è¨­å®šï¼š")
                    .appendField(new Blockly.FieldDropdown([
                        ["ã‚¿ã‚¤ãƒˆãƒ«", "title"],
                        ["èª¬æ˜æ–‡", "description"],
                        ["è‰² (0xHex)", "color"],
                        ["ç”»åƒURL", "image"],
                    ]), "PROPERTY");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(100);
            }
        };

        Blockly.Blocks['add_embed_field'] = {
            init: function() {
                this.appendValueInput("NAME").setCheck("String").appendField("é …ç›®å");
                this.appendValueInput("VALUE").setCheck("String").appendField("å†…å®¹");
                this.appendDummyInput().appendField("æ¨ªä¸¦ã³").appendField(new Blockly.FieldCheckbox("TRUE"), "INLINE");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(100);
            }
        };

        // --- ç®¡ç† ---
        Blockly.Blocks['kick_user'] = {
            init: function() {
                this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ‘¢ Kickã™ã‚‹ (ID");
                this.appendValueInput("REASON").setCheck("String").appendField("ç†ç”±");
                this.appendDummyInput().appendField(")");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(0);
                this.setTooltip("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿½æ”¾ã—ã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['ban_user'] = {
            init: function() {
                this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸš« BANã™ã‚‹ (ID");
                this.appendValueInput("REASON").setCheck("String").appendField("ç†ç”±");
                this.appendDummyInput().appendField(")");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(0);
                this.setTooltip("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ°¸ä¹…è¿½æ”¾ã—ã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['timeout_user'] = {
            init: function() {
                this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ”‡ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (ID");
                this.appendValueInput("MINUTES").setCheck("Number").appendField("åˆ†");
                this.appendDummyInput().appendField("é–“)");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(0);
                this.setTooltip("æŒ‡å®šã—ãŸæ™‚é–“ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™ºè¨€ã§ããªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚");
            }
        };

        Blockly.Blocks['add_user_role'] = {
            init: function() {
                this.appendValueInput("USER_ID").setCheck("String").appendField("â• ãƒ­ãƒ¼ãƒ«ä»˜ä¸ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ID");
                this.appendValueInput("ROLE_ID").setCheck("String").appendField("ãƒ­ãƒ¼ãƒ«ID");
                this.appendDummyInput().appendField(")");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(0);
            }
        };
        
        Blockly.Blocks['remove_user_role'] = {
            init: function() {
                this.appendValueInput("USER_ID").setCheck("String").appendField("â– ãƒ­ãƒ¼ãƒ«å‰¥å¥ª (ãƒ¦ãƒ¼ã‚¶ãƒ¼ID");
                this.appendValueInput("ROLE_ID").setCheck("String").appendField("ãƒ­ãƒ¼ãƒ«ID");
                this.appendDummyInput().appendField(")");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(0);
            }
        };

        Blockly.Blocks['create_role'] = {
            init: function() {
                this.appendValueInput("NAME").setCheck("String").appendField("ğŸ”° æ–°è¦ãƒ­ãƒ¼ãƒ«ä½œæˆ (åå‰");
                this.appendDummyInput().appendField(")");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(0);
            }
        };
        
        Blockly.Blocks['change_nickname'] = {
            init: function() {
                this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ·ï¸ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´ (ID");
                this.appendValueInput("NAME").setCheck("String").appendField("æ–°ã—ã„åå‰");
                this.appendDummyInput().appendField(")");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(0);
            }
        };

        Blockly.Blocks['random_integer'] = {
            init: function() {
                this.appendValueInput("FROM").setCheck("Number").appendField("ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°");
                this.appendValueInput("TO").setCheck("Number").appendField("ã‹ã‚‰");
                this.setOutput(true, "Number");
                this.setColour(230);
            }
        };

        // ===========================================
        // 2. Python (discord.py) Generator Definitions
        // ===========================================

        // èµ·å‹•æ™‚
        Blockly.Python['on_ready'] = function(block) {
            const branch = Blockly.Python.statementToCode(block, 'DO') || '    pass';
            return `@bot.event\nasync def on_ready():\n    print(f'Logged in as {bot.user}')\n    try:\n        synced = await bot.tree.sync()\n        print(f"Synced {len(synced)} command(s)")\n    except Exception as e:\n        print(e)\n${branch}\n`;
        };

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        Blockly.Python['on_message_create'] = function(block) {
            const branch = Blockly.Python.statementToCode(block, 'DO') || '    pass';
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ 'message' å¤‰æ•°ã‚’æä¾›
            return `@bot.event\nasync def on_message(message):\n    if message.author == bot.user:\n        return\n    # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ•°ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹\n    ctx = message\n    user = message.author\n${branch}\n    await bot.process_commands(message)\n`; // <- process_commandsã¯å¿…é ˆ
        };

        Blockly.Python['get_message_content'] = function(block) {
            return ['message.content', Blockly.Python.ORDER_ATOMIC];
        };

        // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰
        Blockly.Python['on_command_executed'] = function(block) {
            const commandName = block.getFieldValue('COMMAND_NAME').toLowerCase();
            const branch = Blockly.Python.statementToCode(block, 'DO') || '    pass';
            // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ 'interaction' å¤‰æ•°ã‚’æä¾›ã€å…±é€šåˆ©ç”¨ã®ãŸã‚ã« 'ctx' ã‚‚å®šç¾©
            return `@bot.tree.command(name="${commandName}", description="${commandName} command")\nasync def ${commandName}(interaction: discord.Interaction):\n    # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ•°ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹\n    ctx = interaction\n    user = interaction.user\n${branch}\n`;
        };
        
        // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ (è¿½åŠ )
        Blockly.Python['prefix_command'] = function(block) {
            // !pingã®!ã‚’å–ã‚Šé™¤ããªã©ã€ä¸€èˆ¬çš„ãªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ã‚³ãƒãƒ³ãƒ‰åã‹ã‚‰é™¤å¤–
            const commandName = block.getFieldValue('COMMAND_NAME').replace(/^[!~#&?]/, '');
            const branch = Blockly.Python.statementToCode(block, 'DO') || '    pass';
            
            // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ã§ã¯ctxã¯Contextã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            return `@bot.command(name='${commandName}')\nasync def ${commandName}_cmd(ctx):\n    user = ctx.author\n${branch}\n`;
        };
        // ------------------------------------

        Blockly.Python['get_command_arg'] = function(block) {
            const argName = block.getFieldValue('ARG_NAME');
            return [`# å¼•æ•°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼: ${argName} (é–¢æ•°å®šç¾©ã§å¼•æ•°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„)`, Blockly.Python.ORDER_ATOMIC];
        };

        // æƒ…å ±å–å¾— (New)
        Blockly.Python['get_user_info'] = function(block) {
            const type = block.getFieldValue('TYPE');
            // userå¤‰æ•°ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å†…ã§è‡ªå‹•å®šç¾©ã•ã‚Œã¦ã„ã‚‹å‰æ
            let code = `user.${type}`;
            return [code, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['get_channel_info'] = function(block) {
            const type = block.getFieldValue('TYPE');
            let code = `ctx.channel.${type}`;
            return [code, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['get_server_info'] = function(block) {
            const type = block.getFieldValue('TYPE');
            // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰: interaction.guild, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: message.guild
            let code = `ctx.guild.${type}`;
            return [code, Blockly.Python.ORDER_ATOMIC];
        };

        // è¿”ä¿¡ãƒ»é€ä¿¡
        Blockly.Python['reply_message'] = function(block) {
            const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
            const ephemeral = block.getFieldValue('EPHEMERAL') === 'TRUE' ? 'True' : 'False';
            
            // Interaction(ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰)ã¨Context(ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰)ã¨Message(é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)ã«å¯¾å¿œ
            let contentCode;
            if (msg.startsWith('discord.Embed')) {
                contentCode = `embed=${msg}`;
            } else {
                contentCode = `content=${msg}`;
            }

            return `
if isinstance(ctx, discord.Interaction):
    await ctx.response.send_message(${contentCode}, ephemeral=${ephemeral})
elif isinstance(ctx, commands.Context):
    await ctx.send(${contentCode})
else:
    # é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®è¿”ä¿¡ã§ã¯ephemeralã¯ç„¡è¦–ã•ã‚Œã¾ã™
    await ctx.reply(${contentCode})
`;
        };

        Blockly.Python['edit_reply'] = function(block) {
            const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
            let contentCode = msg.startsWith('discord.Embed') ? `embed=${msg}` : `content=${msg}`;
            
            // Interactionã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿æœ‰åŠ¹
            return `
if isinstance(ctx, discord.Interaction):
    await ctx.edit_original_response(${contentCode})
`;
        };

        Blockly.Python['send_channel_message'] = function(block) {
            const channelId = Blockly.Python.valueToCode(block, 'CHANNEL_ID', Blockly.Python.ORDER_NONE) || '""';
            const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
            const contentArg = msg.startsWith('discord.Embed') ? `embed=${msg}` : `content=${msg}`;
            return `channel = bot.get_channel(int(${channelId}))\nif channel:\n    await channel.send(${contentArg})\n`;
        };

        Blockly.Python['delete_message'] = function(block) {
            return `
if 'message' in locals():
    await message.delete()
elif isinstance(ctx, commands.Context):
    await ctx.message.delete()
elif isinstance(ctx, discord.Interaction):
    # ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®å ´åˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç›´æ¥ã¯ã§ãã¾ã›ã‚“
    pass
`;
        };
        
        Blockly.Python['purge_messages'] = function(block) {
            const limit = Blockly.Python.valueToCode(block, 'LIMIT', Blockly.Python.ORDER_NONE) || '5';
            return `
if isinstance(ctx, discord.Interaction) or isinstance(ctx, commands.Context):
    await ctx.channel.purge(limit=${limit})
else:
    await ctx.channel.purge(limit=${limit})
`;
        };

        Blockly.Python['pin_message'] = function(block) {
            return `
if 'message' in locals():
    await message.pin()
elif isinstance(ctx, commands.Context):
    await ctx.message.pin()
`;
        };
        
        Blockly.Python['add_reaction'] = function(block) {
            const emoji = Blockly.Python.valueToCode(block, 'EMOJI', Blockly.Python.ORDER_NONE) || '"ğŸ‘"';
            return `try:\n    if 'message' in locals(): await message.add_reaction(${emoji})\n    elif isinstance(ctx, commands.Context): await ctx.message.add_reaction(${emoji})\nexcept:\n    pass\n`;
        };
        
        Blockly.Python['create_thread'] = function(block) {
            const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"New Thread"';
            return `try:\n    if 'message' in locals(): await message.create_thread(name=${name})\n    elif isinstance(ctx, commands.Context): await ctx.message.create_thread(name=${name})\nexcept:\n    pass\n`;
        };

        // ãƒãƒ£ãƒ³ãƒãƒ«æ“ä½œ
        Blockly.Python['create_text_channel'] = function(block) {
            const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"new-channel"';
            return `
if ctx.guild:
    await ctx.guild.create_text_channel(name=${name})
`;
        };

        Blockly.Python['delete_channel'] = function(block) {
            const channelId = Blockly.Python.valueToCode(block, 'CHANNEL_ID', Blockly.Python.ORDER_NONE);
            return `
ch = bot.get_channel(int(${channelId}))
if ch:
    await ch.delete()
`;
        };

        // Botè¨­å®š
        Blockly.Python['set_bot_status'] = function(block) {
            const status = Blockly.Python.valueToCode(block, 'STATUS', Blockly.Python.ORDER_NONE) || '"Bot"';
            const type = block.getFieldValue('TYPE');
            let activityCode = `discord.Game(name=${status})`;
            if (type === 'watching') activityCode = `discord.Activity(type=discord.ActivityType.watching, name=${status})`;
            if (type === 'listening') activityCode = `discord.Activity(type=discord.ActivityType.listening, name=${status})`;
            
            return `await bot.change_presence(activity=${activityCode})\n`;
        };

        Blockly.Python['wait_seconds'] = function(block) {
            const sec = Blockly.Python.valueToCode(block, 'SECONDS', Blockly.Python.ORDER_NONE) || '1';
            return `await asyncio.sleep(${sec})\n`;
        };

        // Embed
        Blockly.Python['create_embed'] = function(block) {
            return [`discord.Embed(title="New Embed", description="å†…å®¹ã‚’è¨­å®šã—ã¦ãã ã•ã„")`, Blockly.Python.ORDER_ATOMIC];
        };
        
        Blockly.Python['set_embed_property'] = function(block) {
            return `# Embedã®è¨­å®šã¯Pythonã‚³ãƒ¼ãƒ‰ä¸Šã§ç›´æ¥ç·¨é›†ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™\n`;
        };
        
        Blockly.Python['add_embed_field'] = function(block) {
            return `# Embedãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ \n`;
        };

        // ç®¡ç†æ©Ÿèƒ½
        Blockly.Python['kick_user'] = function(block) {
            const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
            const reason = Blockly.Python.valueToCode(block, 'REASON', Blockly.Python.ORDER_NONE);
            return `user = ctx.guild.get_member(int(${user}))\nif user:\n    await user.kick(reason=${reason})\n`;
        };
        
        Blockly.Python['ban_user'] = function(block) {
            const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
            const reason = Blockly.Python.valueToCode(block, 'REASON', Blockly.Python.ORDER_NONE);
            return `user = ctx.guild.get_member(int(${user}))\nif user:\n    await user.ban(reason=${reason})\n`;
        };
        
        Blockly.Python['timeout_user'] = function(block) {
            const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
            const mins = Blockly.Python.valueToCode(block, 'MINUTES', Blockly.Python.ORDER_NONE) || '5';
            return `user = ctx.guild.get_member(int(${user}))\nif user:\n    await user.timeout(datetime.timedelta(minutes=${mins}))\n`;
        };

        Blockly.Python['add_user_role'] = function(block) {
            const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
            const role = Blockly.Python.valueToCode(block, 'ROLE_ID', Blockly.Python.ORDER_NONE);
            return `member = ctx.guild.get_member(int(${user}))\nrole = ctx.guild.get_role(int(${role}))\nif member and role:\n    await member.add_roles(role)\n`;
        };

        Blockly.Python['remove_user_role'] = function(block) {
            const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
            const role = Blockly.Python.valueToCode(block, 'ROLE_ID', Blockly.Python.ORDER_NONE);
            return `member = ctx.guild.get_member(int(${user}))\nrole = ctx.guild.get_role(int(${role}))\nif member and role:\n    await member.remove_roles(role)\n`;
        };

        Blockly.Python['create_role'] = function(block) {
            const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE);
            return `await ctx.guild.create_role(name=${name})\n`;
        };
        
        Blockly.Python['change_nickname'] = function(block) {
            const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
            const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE);
            return `member = ctx.guild.get_member(int(${user}))\nif member:\n    await member.edit(nick=${name})\n`;
        };

        Blockly.Blocks['random_integer'] = {
            init: function() {
                this.appendValueInput("FROM").setCheck("Number").appendField("ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°");
                this.appendValueInput("TO").setCheck("Number").appendField("ã‹ã‚‰");
                this.setOutput(true, "Number");
                this.setColour(230);
            }
        };
        
        Blockly.Python['random_integer'] = function(block) {
            const from = Blockly.Python.valueToCode(block, 'FROM', Blockly.Python.ORDER_NONE) || '0';
            const to = Blockly.Python.valueToCode(block, 'TO', Blockly.Python.ORDER_NONE) || '100';
            return [`random.randint(${from}, ${to})`, Blockly.Python.ORDER_ATOMIC];
        };

        // ===========================================
        // 3. Main Logic
        // ===========================================

        const codeModal = document.getElementById('codeModal');
        const showCodeBtn = document.getElementById('showCodeBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const codeOutput = document.getElementById('codeOutput');
        const saveStatus = document.getElementById('saveStatus');
        const importInput = document.getElementById('importInput');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');

        // Save to LocalStorage
        const saveToLocal = () => {
            if (!workspace) return;
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToText(xml);
            localStorage.setItem(STORAGE_KEY, xmlText);
            
            saveStatus.style.opacity = '1';
            setTimeout(() => saveStatus.style.opacity = '0', 2000);
        };

        // Load from LocalStorage
        const loadFromLocal = () => {
            const xmlText = localStorage.getItem(STORAGE_KEY);
            if (xmlText && workspace) {
                const xml = Blockly.Xml.textToDom(xmlText);
                Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
            }
        };

        // File Import/Export
        importBtn.addEventListener('click', () => importInput.click());
        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const xml = Blockly.Xml.textToDom(e.target.result);
                    Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
                    saveToLocal(); // Importã—ãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°
                } catch (err) {
                    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆã®ä»£ã‚ã‚Šã«console.errorã‚’ä½¿ç”¨
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset
        });

        exportBtn.addEventListener('click', () => {
            if (!workspace) return;
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToText(xml);
            const blob = new Blob([xmlText], {type: 'text/xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bot-project-${new Date().toISOString().slice(0,10)}.xml`;
            a.click();
            URL.revokeObjectURL(url);
        });

        const generatePythonCode = () => {
            let rawCode = Blockly.Python.workspaceToCode(workspace);
            
            // ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å®šç¾© (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯'!')
            // ã“ã“ã‚’å¤‰æ›´ã™ã‚Œã°ã€ä»–ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«ã‚‚å¯¾å¿œã§ãã¾ã™
            const commandPrefix = '!'; 

            const boilerplate = `
import discord
from discord import app_commands
from discord.ext import commands
import random
import asyncio
import datetime

# ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã®è¨­å®šï¼ˆBotã®æ¨©é™è¨­å®šï¼‰
intents = discord.Intents.default()
intents.message_content = True # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ã‚’èª­ã¿å–ã‚‹æ¨©é™ (ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ã«å¿…è¦)
intents.members = True # ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’èª­ã¿å–ã‚‹æ¨©é™

# Botã®ä½œæˆ (ã“ã“ã§ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒ‡å®š)
bot = commands.Bot(command_prefix='${commandPrefix}', intents=intents)

# --- ä½œæˆã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
${rawCode}
# -------------------------------

# Botã®èµ·å‹•
# æ³¨æ„: Bot Tokenã¯ä»–äººã«æ•™ãˆãªã„ã§ãã ã•ã„
bot.run('YOUR_BOT_TOKEN_HERE')
`;
            return boilerplate.trim();
        };

        const initializeApp = () => {
            const blocklyDiv = document.getElementById('blocklyDiv');
            const toolbox = document.getElementById('toolbox');
            
            workspace = Blockly.inject(blocklyDiv, {
                toolbox: toolbox,
                horizontalLayout: false,
                trashcan: true,
                zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
                renderer: 'zelos',
                theme: savedTheme === 'dark' ? modernDarkTheme : modernLightTheme
            });

            loadFromLocal();

            workspace.addChangeListener((e) => {
                if (e.isUiEvent || e.type === Blockly.Events.FINISHED_LOADING) return;
                saveToLocal();
            });

            showCodeBtn.addEventListener('click', () => {
                codeOutput.textContent = generatePythonCode();
                codeModal.classList.remove('hidden');
                codeModal.classList.add('flex');
                setTimeout(() => codeModal.classList.add('show-modal'), 10);
            });

            closeModalBtn.addEventListener('click', () => {
                codeModal.classList.remove('show-modal');
                setTimeout(() => {
                    codeModal.classList.remove('flex');
                    codeModal.classList.add('hidden');
                }, 200);
            });
            
            copyCodeBtn.addEventListener('click', () => {
                // execCommand('copy')ã®ä»£ã‚ã‚Šã«navigator.clipboardã‚’ä½¿ç”¨
                navigator.clipboard.writeText(codeOutput.textContent).then(() => {
                    const originalText = copyCodeBtn.innerHTML;
                    copyCodeBtn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> ã‚³ãƒ”ãƒ¼å®Œäº†';
                    lucide.createIcons();
                    setTimeout(() => {
                        copyCodeBtn.innerHTML = originalText;
                        lucide.createIcons();
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            });
        };

        window.onload = initializeApp;

    </script>
</body>
</html>
